<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inscriptions - Outils Profs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #000; color: #eee; padding: 10px; margin: 0; }
        
        .light-card { background: #e5e7eb; color: #111827; border-radius: 1.5rem; }

        .card-input { display: none; }
        .card-label {
            display: flex; align-items: center; justify-content: center; text-align: center;
            background: #d1d5db; border: 2px solid #9ca3af; color: #374151;
            padding: 8px 4px; border-radius: 0.75rem; cursor: pointer;
            font-size: 0.65rem; font-weight: 800; text-transform: uppercase;
            transition: all 0.2s; 
        }

        .input-garcon:checked + .card-label { color: #2563eb; border-color: #2563eb; font-weight: 900; }
        .input-fille:checked + .card-label { color: #db2777; border-color: #db2777; font-weight: 900; }

        .input-cp:checked + .card-label { background: #ec4899; border-color: #ec4899; color: #fff; } 
        .input-ce1:checked + .card-label { background: #3b82f6; border-color: #3b82f6; color: #fff; } 
        .input-ce2:checked + .card-label { background: #eab308; border-color: #eab308; color: #000; } 
        .input-cm1:checked + .card-label { background: #ef4444; border-color: #ef4444; color: #fff; } 
        .input-cm2:checked + .card-label { background: #22c55e; border-color: #22c55e; color: #fff; } 
        .input-autre:checked + .card-label { background: #8b5cf6; border-color: #8b5cf6; color: #fff; } 

        .card-input:checked + .card-label { transform: scale(0.95); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }

        .level-column { background: rgba(24, 24, 27, 0.6); border: none; border-radius: 1.25rem; padding: 10px; height: fit-content; }

        .text-m { color: #2563eb; } 
        .text-f { color: #db2777; } 
        
        /* Modifi√© : Ajout d'un curseur pointer et d'un effet hover sur l'√©tiquette */
        .student-item { background: #fff; padding: 6px 10px; border-radius: 0.75rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; cursor: pointer; transition: background 0.2s; }
        .student-item:hover { background: #f3f4f6; }

        .btn-nav { font-weight: 800; padding: 12px 4px; border-radius: 50px; font-size: 9px; text-align: center; width: 100%; }
        .input-field { background: #ffffff; border: 1px solid #9ca3af; color: #111827; border-radius: 0.75rem; padding: 10px; outline: none; font-size: 0.75rem; font-weight: 600; }
        
        /* Style sp√©cial quand on est en mode √©dition */
        .editing-mode { border: 2px solid #ef4444 !important; }
    </style>
</head>
<body class="pb-10">
    <div class="max-w-4xl mx-auto">
        
        <div class="flex items-center justify-between py-2 mb-2">
            <a href="index.html" id="btn-retour" class="flex items-center justify-center w-8 h-8 rounded-full shadow-lg transition-transform active:scale-90">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <h1 id="page-title" class="text-lg font-black tracking-normal uppercase">Enregistrement des √©l√®ves</h1>
            <div class="w-8"></div> 
        </div>
        
        <div id="form-container" class="max-w-md mx-auto light-card p-4 mb-6 shadow-2xl">
            <form id="eleveForm" class="flex flex-col gap-3">
                <input type="hidden" id="edit-id" value="">
                
                <input type="text" id="nomComplet" placeholder="Pr√©nom NOM" class="input-field w-full" required>
                
                <div class="grid grid-cols-2 gap-2">
                    <label><input type="radio" name="sexe" value="m" class="card-input input-garcon" checked><div class="card-label">Gar√ßon</div></label>
                    <label><input type="radio" name="sexe" value="f" class="card-input input-fille"><div class="card-label">Fille</div></label>
                </div>

                <div class="grid grid-cols-3 gap-1.5">
                    <label><input type="radio" name="niveau" value="CP" class="card-input input-cp"><div class="card-label">CP</div></label>
                    <label><input type="radio" name="niveau" value="CE1" class="card-input input-ce1"><div class="card-label">CE1</div></label>
                    <label><input type="radio" name="niveau" value="CE2" class="card-input input-ce2" checked><div class="card-label">CE2</div></label>
                    <label><input type="radio" name="niveau" value="CM1" class="card-input input-cm1"><div class="card-label">CM1</div></label>
                    <label><input type="radio" name="niveau" value="CM2" class="card-input input-cm2"><div class="card-label">CM2</div></label>
                    <label><input type="radio" name="niveau" value="AUTRE" class="card-input input-autre"><div class="card-label">Autre</div></label>
                </div>

                <button type="submit" id="btn-submit" class="font-black py-3 rounded-full uppercase text-xs active:scale-95 transition-transform mt-1">Enregistrer</button>

                <div class="pt-3 border-t border-gray-300 text-center">
                    <label id="label-import" class="text-[9px] font-bold block mb-1">Importer un fichier .txt (Pr√©nom;NOM;Genre;Niveau)</label>
                    <input type="file" id="fileInput" accept=".txt,.csv" class="text-[9px] text-gray-600">
                </div>
            </form>
        </div>

        <div id="listeContainer"></div>

        <div class="max-w-md mx-auto flex flex-col gap-3 mt-6 mb-10">
            <button onclick="exporterListe()" class="btn-nav bg-neutral-800 text-white">üëÜexporter la liste .txtüëÜ </button>
            <button onclick="toutEffacer()" class="btn-nav bg-red-500 text-red-100">‚ö†Ô∏è effacer la liste</button>
        </div>
    </div>

    <script>
        const mapCouleurs = {
            'red': '#ef4444', 'orange': '#f97316', 'amber': '#f59e0b', 'yellow': '#eab308',
            'lime': '#84cc16', 'green': '#22c55e', 'emerald': '#10b981', 'teal': '#14b8a6',
            'cyan': '#06b6d4', 'sky': '#0ea5e9', 'blue': '#3b82f6', 'indigo': '#6366f1',
            'violet': '#8b5cf6', 'purple': '#a855f7', 'fuchsia': '#d946ef', 'pink': '#ec4899',
            'rose': '#f43f5e', 'gray': '#6b7280'
        };

        const couleurParNiveau = {
            'CP': '#ec4899', 'CE1': '#3b82f6', 'CE2': '#eab308', 'CM1': '#ef4444', 'CM2': '#22c55e', 'AUTRE': '#8b5cf6'
        };

        const ordreNiveaux = ['CP', 'CE1', 'CE2', 'CM1', 'CM2', 'AUTRE'];
        const themePrefs = JSON.parse(localStorage.getItem('theme_tuiles')) || {};
        const couleurInscr = themePrefs.inscr || 'lime';
        const hexaTheme = mapCouleurs[couleurInscr];

        function appliquerCouleursTheme() {
            document.getElementById('page-title').style.color = hexaTheme;
            document.getElementById('label-import').style.color = hexaTheme;
            document.getElementById('btn-retour').style.backgroundColor = hexaTheme;
            const btnSubmit = document.getElementById('btn-submit');
            btnSubmit.style.backgroundColor = hexaTheme;
            btnSubmit.style.color = ['yellow', 'lime', 'amber', 'cyan'].includes(couleurInscr) ? '#000' : '#fff';
        }

        let eleves = JSON.parse(localStorage.getItem('maListeEleves')) || [];

        function formaterIdentite(prenom, nom) {
            const p = prenom.trim();
            const n = nom.trim().toUpperCase();
            return p.charAt(0).toUpperCase() + p.slice(1).toLowerCase() + " " + n;
        }

        // FONCTION DE MODIFICATION
        function preparerModification(id) {
            const el = eleves.find(e => e.id === id);
            if (!el) return;

            document.getElementById('edit-id').value = el.id;
            document.getElementById('nomComplet').value = el.identite;
            document.querySelector(`input[name="sexe"][value="${el.sexe}"]`).checked = true;
            document.querySelector(`input[name="niveau"][value="${el.niveau}"]`).checked = true;
            
            const btn = document.getElementById('btn-submit');
            btn.innerText = "Mettre √† jour l'√©l√®ve";
            btn.classList.add('bg-orange-500'); // Change de couleur pour alerter

            document.getElementById('form-container').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('nomComplet').focus();
        }

        document.getElementById('eleveForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const editId = document.getElementById('edit-id').value;
            const saisie = document.getElementById('nomComplet').value.trim().split(" ");
            const prenom = saisie[0] || "";
            const nom = saisie.slice(1).join(" ") || "";
            const sexe = document.querySelector('input[name="sexe"]:checked').value;
            const niveau = document.querySelector('input[name="niveau"]:checked').value;
            
            if (editId) {
                // Mode mise √† jour : on remplace l'ancien par le nouveau
                const index = eleves.findIndex(el => el.id == editId);
                eleves[index] = { ...eleves[index], identite: formaterIdentite(prenom, nom), sexe, niveau };
                // Reset formulaire
                document.getElementById('edit-id').value = "";
                document.getElementById('btn-submit').innerText = "Enregistrer";
                appliquerCouleursTheme();
            } else {
                // Mode cr√©ation
                eleves.push({ id: Date.now(), identite: formaterIdentite(prenom, nom), sexe, niveau });
            }
            
            sauvegarder();
            e.target.reset();
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const lignes = e.target.result.split(/\r?\n/);
                lignes.forEach(l => {
                    const clean = l.trim();
                    if (!clean) return;
                    const p = clean.split(';'); 
                    if(p.length >= 4) {
                        eleves.push({
                            id: Date.now() + Math.random(),
                            identite: formaterIdentite(p[0], p[1]),
                            sexe: p[2].trim().toLowerCase(),
                            niveau: p[3].trim().toUpperCase()
                        });
                    }
                });
                sauvegarder();
            };
            reader.readAsText(file);
        });

        function sauvegarder() {
            localStorage.setItem('maListeEleves', JSON.stringify(eleves));
            render();
        }

        function render() {
            const container = document.getElementById('listeContainer');
            container.innerHTML = "";
            if (eleves.length === 0) {
                container.innerHTML = '<p class="text-center text-zinc-600 text-xs py-10 italic">Aucun √©l√®ve inscrit.</p>';
                return;
            }

            const groupes = {};
            eleves.forEach(el => {
                const niv = el.niveau.toUpperCase();
                if (!groupes[niv]) groupes[niv] = [];
                groupes[niv].push(el);
            });

            const nomsNiveauxPresents = Object.keys(groupes).sort((a, b) => ordreNiveaux.indexOf(a) - ordreNiveaux.indexOf(b));
            
            if (nomsNiveauxPresents.length === 2) container.className = "grid grid-cols-2 gap-3 items-start";
            else if (nomsNiveauxPresents.length >= 3) container.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 items-start";
            else container.className = "flex flex-col gap-4 max-w-md mx-auto";

            nomsNiveauxPresents.forEach(niv => {
                const col = document.createElement('div');
                col.className = "level-column";
                const colColor = couleurParNiveau[niv] || hexaTheme;
                col.innerHTML = `<h3 class="text-[11px] font-black uppercase mb-1 text-center tracking-widest pb-1" style="color:${colColor}">${niv} ‚Äî ${groupes[niv].length}</h3>`;
                
                const list = document.createElement('div');
                groupes[niv].sort((a,b) => a.identite.localeCompare(b.identite)).forEach(el => {
                    const item = document.createElement('div');
                    item.className = 'student-item';
                    
                    // L'√©tiquette devient cliquable pour modifier
                    item.onclick = (e) => {
                        // On v√©rifie qu'on ne clique pas sur le bouton supprimer
                        if (!e.target.closest('button')) preparerModification(el.id);
                    };

                    item.innerHTML = `
                        <span class="text-[9px] font-bold pr-2 text-${el.sexe} whitespace-normal break-words leading-tight">${el.identite}</span>
                        <button onclick="supprimer(${el.id})" class="opacity-40 hover:opacity-100 transition-opacity p-1 text-zinc-400 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>`;
                    list.appendChild(item);
                });
                col.appendChild(list);
                container.appendChild(col);
            });
        }

        function supprimer(id) {
            if(confirm("Supprimer cet √©l√®ve ?")) {
                eleves = eleves.filter(e => e.id !== id);
                sauvegarder();
            }
        }

        function toutEffacer() {
            if(confirm("Attention : Supprimer toute la liste d'√©l√®ves ?")) {
                eleves = [];
                sauvegarder();
            }
        }

        function exporterListe() {
            if (eleves.length === 0) return alert("Liste vide !");
            let contenu = "";
            eleves.forEach(el => {
                const parts = el.identite.split(" ");
                contenu += `${parts[0]};${parts.slice(1).join(" ")};${el.sexe};${el.niveau}\n`;
            });
            const blob = new Blob([contenu], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'liste_eleves.txt';
            a.click();
        }

        window.addEventListener('DOMContentLoaded', () => {
            appliquerCouleursTheme();
            render();
        });
    </script>
</body>
</html>